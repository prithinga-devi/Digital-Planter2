<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Planter - Premium Edition</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="static/styles/theme.css">
    <link rel="stylesheet" href="static/styles/components.css">
</head>

<body>
    <!-- THREE-ZONE LAYOUT -->
    <div class="app-layout" id="appLayout">

        <!-- ZONE A: Command Rail -->
        <nav class="command-rail">
            <!-- User Avatar -->
            <div class="rail-avatar" id="userAvatar" onclick="window.location.href='logged.html'" title="Profile">
                U
            </div>

            <!-- Navigation Icons -->
            <div class="rail-nav">
                <button class="rail-item active" title="Home" onclick="showHome()">üå±</button>
                <button class="rail-item" title="My Plants" onclick="window.location.href='locations.html'">üìç</button>
                <button class="rail-item" title="Statistics" onclick="showStats()">üìà</button>
                <button class="rail-item" title="Settings">‚öôÔ∏è</button>
            </div>

            <!-- Footer: Theme Toggle -->
            <div class="rail-footer">
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Theme">
                    üåô
                </button>
            </div>
        </nav>

        <!-- ZONE B: Primary Viewport (Map) -->
        <main class="primary-viewport">

            <!-- Floating Search Bar -->
            <div class="floating-search">
                <div class="search-container glass">
                    <div class="search-input-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="searchLocation"
                            placeholder="Search for a location..."
                            onkeypress="if(event.key==='Enter') searchLocation()">
                    </div>
                    <button class="search-btn" onclick="searchLocation()">Search</button>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map"></div>

            <!-- Location Info Pill -->
            <div class="location-pill glass" id="locationInfo" style="display: none;">
                üìç Location will appear here
            </div>

            <!-- FAB: Plant New -->
            <button class="fab-plant" onclick="openTray()" title="Plant Something New">
                üåø
            </button>

        </main>

        <!-- ZONE C: Action Tray (Slide-in Panel) -->
        <aside class="action-tray" id="actionTray">

            <!-- Tray Header -->
            <div class="tray-header">
                <h2 class="tray-title">
                    <span>üå±</span> Plant New Life
                </h2>
                <button class="tray-close" onclick="closeTray()">‚úï</button>
            </div>

            <!-- Tray Content -->
            <div class="tray-content">

                <!-- Photo Upload -->
                <div class="form-group">
                    <label class="form-label">Photo (Optional)</label>
                    <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                        <div id="uploadPlaceholder">
                            <span class="icon">üì∑</span>
                            <span>Tap to add photo</span>
                        </div>
                        <img id="photoPreview" class="photo-preview" style="display:none;">
                    </div>
                    <input type="file" id="photoInput" accept="image/*" onchange="previewPhoto(event)"
                        style="display:none;">
                </div>

                <!-- Plant Name -->
                <div class="form-group">
                    <label class="form-label">Plant Name</label>
                    <input type="text" id="plantName" placeholder="e.g., Sunset Oak">
                </div>

                <!-- Type Selection -->
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <div class="type-selection">
                        <div class="type-card selected" onclick="selectType('tree')" id="card-tree">
                            <span class="icon">üå≥</span>
                            <span>Tree</span>
                        </div>
                        <div class="type-card" onclick="selectType('flower')" id="card-flower">
                            <span class="icon">üå∏</span>
                            <span>Flower</span>
                        </div>
                    </div>
                    <input type="hidden" id="plantType" value="tree">
                </div>

                <!-- Selected Location Display -->
                <div class="form-group" id="selectedLocationGroup" style="display: none;">
                    <label class="form-label">Selected Location</label>
                    <div class="glass" style="padding: 12px; border-radius: var(--radius-md); font-size: 0.875rem;">
                        <span id="selectedLocationText">Click on the map to select</span>
                    </div>
                </div>

            </div>

            <!-- Tray Footer -->
            <div class="tray-footer">
                <button class="btn-deploy" onclick="deployPlant()">
                    üöÄ Deploy Seed
                </button>
            </div>

        </aside>

    </div>

    <!-- Status Toast -->
    <div id="statusToast" style="
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 100px;
        background: var(--surface-elevated);
        color: var(--text-primary);
        font-size: 0.875rem;
        box-shadow: var(--shadow-medium);
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
    "></div>

    <!-- Success Modal -->
    <div id="successModal" style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    ">
        <div style="
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: var(--radius-xl);
            text-align: center;
            max-width: 400px;
            margin: 20px;
        ">
            <div style="font-size: 4rem; margin-bottom: 16px;">üéâ</div>
            <h2 style="color: var(--accent-primary); margin-bottom: 12px;">Seed Deployed!</h2>
            <p id="successMessage" style="color: var(--text-secondary); margin-bottom: 24px;">Your plant has been added
                to the garden.</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-primary" onclick="window.location.href='locations.html'">View Garden</button>
                <button class="btn btn-secondary" onclick="closeSuccessModal()">Plant More</button>
            </div>
        </div>
    </div>

    <!-- Theme Script -->
    <script type="module">
        import { toggleTheme } from './static/js/theme.js';
        window.toggleTheme = toggleTheme;
    </script>

    <!-- Firebase Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
        import { firebaseConfig } from "./static/js/config.js";
        import { addPlant } from "./static/js/dataService.js";
        import { reverseGeocode } from "./static/js/utils.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Auth State
        onAuthStateChanged(auth, (user) => {
            const avatar = document.getElementById('userAvatar');
            if (user) {
                let initial = 'U';
                if (user.displayName) initial = user.displayName.charAt(0).toUpperCase();
                else if (user.email) initial = user.email.charAt(0).toUpperCase();
                avatar.textContent = initial;
            }
        });

        // Plant with localStorage
        window.plantWithLocalStorage = async function (name, type, lat, lon, photoDataUrl) {
            try {
                const geoData = await reverseGeocode(lat, lon);
                const newPlant = addPlant({
                    name: name,
                    type: type,
                    lat: lat,
                    lon: lon,
                    photo_url: photoDataUrl,
                    address: geoData.address,
                    landmarks: geoData.landmarks
                });
                return { success: true, plant: newPlant };
            } catch (error) {
                console.error('Error planting:', error);
                return { success: false, error: error.message };
            }
        };
    </script>

    <!-- Main App Logic -->
    <script>
        let map, selectedMarker, selectedLat, selectedLon;
        let isTracking = false, watchId, liveLocationMarker;

        // Initialize Map
        function initMap(lat = 20.5937, lon = 78.9629, zoom = 5) {
            map = L.map('map', { zoomControl: false }).setView([lat, lon], zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Click to select location
            map.on('click', function (e) {
                selectedLat = e.latlng.lat;
                selectedLon = e.latlng.lng;
                if (selectedMarker) map.removeLayer(selectedMarker);
                selectedMarker = L.marker([selectedLat, selectedLon]).addTo(map);

                document.getElementById('selectedLocationGroup').style.display = 'block';
                document.getElementById('selectedLocationText').textContent =
                    `${selectedLat.toFixed(4)}, ${selectedLon.toFixed(4)}`;

                showToast('Location selected!');
            });
        }

        // Tray Controls
        function openTray() {
            document.getElementById('actionTray').classList.add('open');
            document.getElementById('appLayout').classList.add('tray-open');
        }

        function closeTray() {
            document.getElementById('actionTray').classList.remove('open');
            document.getElementById('appLayout').classList.remove('tray-open');
        }

        // Type Selection
        function selectType(type) {
            document.getElementById('plantType').value = type;
            document.querySelectorAll('.type-card').forEach(card => card.classList.remove('selected'));
            document.getElementById(`card-${type}`).classList.add('selected');
        }

        // Search Location
        async function searchLocation() {
            const query = document.getElementById('searchLocation').value.trim();
            if (!query) return;

            showToast('Searching...');
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`,
                    { headers: { 'User-Agent': 'DigitalPlanterApp/2.0' } }
                );
                const results = await response.json();

                if (results.length > 0) {
                    const { lat, lon, display_name } = results[0];
                    map.setView([parseFloat(lat), parseFloat(lon)], 15);

                    if (selectedMarker) map.removeLayer(selectedMarker);
                    selectedMarker = L.marker([lat, lon]).addTo(map);
                    selectedLat = parseFloat(lat);
                    selectedLon = parseFloat(lon);

                    const locationInfo = document.getElementById('locationInfo');
                    locationInfo.textContent = `üìç ${display_name}`;
                    locationInfo.style.display = 'block';

                    showToast('Location found!');
                } else {
                    showToast('Location not found');
                }
            } catch (e) {
                showToast('Search error');
            }
        }

        // Get My Location
        function showHome() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported');
                return;
            }

            showToast('Getting your location...');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const { latitude, longitude } = pos.coords;
                    map.setView([latitude, longitude], 15);

                    if (selectedMarker) map.removeLayer(selectedMarker);
                    selectedMarker = L.marker([latitude, longitude]).addTo(map);
                    selectedLat = latitude;
                    selectedLon = longitude;

                    // Reverse geocode
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`)
                        .then(res => res.json())
                        .then(data => {
                            const locationInfo = document.getElementById('locationInfo');
                            locationInfo.textContent = `üìç ${data.display_name}`;
                            locationInfo.style.display = 'block';
                        });

                    showToast('Located!');
                },
                () => showToast('Unable to get location')
            );
        }

        function showStats() {
            showToast('Statistics coming soon!');
        }

        // Photo Preview
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Deploy Plant
        async function deployPlant() {
            const name = document.getElementById('plantName').value.trim();
            const type = document.getElementById('plantType').value;
            const photoInput = document.getElementById('photoInput');

            if (!name) {
                showToast('Please enter a plant name');
                return;
            }
            if (!selectedLat) {
                showToast('Please select a location on the map');
                return;
            }

            showToast('Deploying seed...');

            try {
                let photoDataUrl = null;
                if (photoInput.files[0]) {
                    photoDataUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(photoInput.files[0]);
                    });
                }

                const result = await window.plantWithLocalStorage(name, type, selectedLat, selectedLon, photoDataUrl);

                if (result.success) {
                    document.getElementById('successMessage').textContent =
                        `You planted a ${type} named "${name}"!`;
                    document.getElementById('successModal').style.display = 'flex';

                    // Reset form
                    document.getElementById('plantName').value = '';
                    document.getElementById('uploadPlaceholder').style.display = 'flex';
                    document.getElementById('photoPreview').style.display = 'none';
                    document.getElementById('photoInput').value = '';
                    document.getElementById('selectedLocationGroup').style.display = 'none';

                    closeTray();
                } else {
                    showToast('Error: ' + (result.error || 'Failed to plant'));
                }
            } catch (e) {
                console.error('Deploy error:', e);
                showToast('Error deploying seed');
            }
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // Toast Notifications
        function showToast(message) {
            const toast = document.getElementById('statusToast');
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2500);
        }

        // Initialize
        initMap();

        // Auto-detect location on load
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 13);
            });
        }
    </script>
</body>

</html>