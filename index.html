<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Planter</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            /* Night Nursery Theme (Primary) */
            --bg-night: #0A140F;
            --surface-night: rgba(18, 30, 24, 0.85);
            --accent-glow: #90EE90;
            --text-main: #F0FDF4;
            --text-muted: #94A3B8;
            --border-glass: rgba(144, 238, 144, 0.15);
            --radius-xl: 32px;
            --radius-lg: 28px;
            --radius-md: 18px;
            --transition-smooth: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --glass-blur: blur(16px);
        }

        [data-theme="light"] {
            /* Fresh Biophilic - Perfect Palette */
            --bg-night: #F0F7F4;
            --surface-night: rgba(255, 255, 255, 0.8);
            --accent-glow: #10B981;
            --text-main: #064E3B;
            --text-muted: #6B7280;
            --border-glass: rgba(16, 185, 129, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-night);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 88px 1fr;
            transition: background-color 0.8s ease;
        }

        /* Zone A: Command Rail */
        .command-rail {
            background-color: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border-right: 1px solid var(--border-glass);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 48px 0 64px;
            justify-content: flex-start;
            z-index: 100;
            width: 88px;
            gap: 48px;
        }

        .rail-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .avatar-container {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--accent-glow), #4ADE80);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--bg-night);
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .avatar-container:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 25px rgba(144, 238, 144, 0.5);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .nav-icons {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .nav-item {
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            border-radius: 16px;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: var(--text-muted);
            background: transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--accent-glow);
            background: rgba(144, 238, 144, 0.1);
            transform: translateY(-2px);
        }

        #logoutBtn:hover {
            color: #EF4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .theme-switch {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .theme-switch:hover {
            transform: rotate(30deg);
            background: rgba(144, 238, 144, 0.2);
        }

        /* Zone B: Primary Viewport */
        .viewport-center {
            position: relative;
            height: 100vh;
            background: #000;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Floating Search overlay */
        .floating-search {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: min(450px, 90%);
            z-index: 50;
            background: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            transition: var(--transition-smooth);
        }

        .floating-search:focus-within {
            width: min(480px, 95%);
            border-color: var(--accent-glow);
            box-shadow: 0 30px 80px rgba(144, 238, 144, 0.2);
        }

        .floating-search input {
            background: none;
            border: none;
            color: var(--text-main);
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            outline: none;
        }

        .floating-search input::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }

        /* Zone C: Action Tray */
        .action-tray {
            position: fixed;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 420px;
            background: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg);
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            transform: translateX(calc(100% + 40px));
            transition: var(--transition-smooth);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.3);
        }

        .action-tray.open {
            transform: translateX(0);
        }

        .tray-header h2 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .tray-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* DEPLOY SEED Button */
        .btn-deploy {
            background: var(--accent-glow);
            color: var(--bg-night);
            border: none;
            border-radius: var(--radius-md);
            padding: 20px;
            font-weight: 800;
            font-size: 14px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(144, 238, 144, 0.3);
        }

        .btn-deploy:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(144, 238, 144, 0.5);
            filter: brightness(1.1);
        }

        /* Premium Form Controls */
        .premium-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            padding: 18px 20px;
            color: var(--text-main);
            width: 100%;
            font-size: 15px;
            transition: var(--transition-smooth);
            outline: none;
        }

        .premium-input:focus {
            background: rgba(144, 238, 144, 0.05);
            border-color: var(--accent-glow);
        }

        /* Photo Area */
        .photo-drop-zone {
            width: 100%;
            height: 180px;
            border: 2px dashed var(--border-glass);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.01);
        }

        .photo-drop-zone:hover {
            border-color: var(--accent-glow);
            background: rgba(144, 238, 144, 0.03);
        }

        /* Helper Styles */
        #status-overlay {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-glass);
            border-radius: 40px;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 2px;
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 60;
            color: var(--accent-glow);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .theme-switch {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.05);
        }

        /* History & Social Styles */
        .tray-section-title {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-glow);
            margin-bottom: 16px;
        }

        .social-share-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .social-btn {
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .social-btn:hover {
            background: var(--accent-glow);
            color: var(--bg-night);
            transform: translateY(-2px);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .history-item {
            padding: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-glass);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .history-item span:first-child {
            font-size: 18px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-glass);
            border-radius: 10px;
        }

        .rail-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }

            .command-rail {
                position: fixed;
                bottom: 0;
                width: 100%;
                height: 80px;
                flex-direction: row;
                padding: 0 24px;
                border-right: none;
                border-top: 1px solid var(--border-glass);
                justify-content: flex-start;
                gap: 24px;
            }

            .rail-top {
                flex-direction: row;
                gap: 0;
                margin-right: 0;
            }

            .nav-icons {
                flex-direction: row;
                width: auto;
                flex: 1;
                justify-content: space-between;
                gap: 0;
            }

            .avatar-container,
            .rail-bottom {
                display: none;
            }

            .action-tray {
                width: 100%;
                right: 0;
                top: 0;
                bottom: 80px;
                border-radius: 0;
            }
        }

        /* Floating Locate Button */
        .locate-btn {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: 56px;
            height: 56px;
            background: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-glass);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-glow);
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: var(--transition-smooth);
        }

        .locate-btn:hover {
            transform: scale(1.1);
            background: var(--accent-glow);
            color: var(--bg-night);
            box-shadow: 0 0 25px rgba(144, 238, 144, 0.4);
        }



        /* Live Status Bar */
        .live-status-bar {
            position: absolute;
            bottom: 40px;
            left: 110px;
            background: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            padding: 10px 16px;
            z-index: 50;
            display: none;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: var(--transition-smooth);
        }

        .live-status-bar.active {
            display: flex;
        }

        .live-status-label {
            font-size: 9px;
            font-weight: 800;
            color: var(--accent-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-status-value {
            font-size: 11px;
            color: var(--text-main);
            font-family: monospace;
        }

        /* Live Orbit Button */
        .live-orbit-btn {
            position: absolute;
            bottom: 110px;
            right: 40px;
            width: 56px;
            height: 56px;
            background: var(--surface-night);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-glass);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: var(--transition-smooth);
        }

        .live-orbit-btn.active {
            color: var(--accent-glow);
            border-color: var(--accent-glow);
            box-shadow: 0 0 20px rgba(144, 238, 144, 0.3);
        }

        .live-orbit-btn:hover {
            transform: scale(1.1);
        }

        .delete-btn-history {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: none;
        }

        .delete-btn-history:hover {
            background: #EF4444;
            color: white;
        }

        /* Permission Alert Modal */
        .permission-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: min(400px, 90%);
            background: var(--surface-night);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg);
            padding: 40px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            gap: 24px;
            text-align: center;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.6);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .permission-modal.active {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1999;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .modal-overlay.active {
            display: block;
            opacity: 1;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-glass);
            color: var(--text-main);
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .command-rail {
                padding: 0 12px;
                gap: 12px;
            }

            .nav-item,
            .theme-switch,
            #loginBtn {
                width: 42px !important;
                height: 42px !important;
                font-size: 20px !important;
                border-radius: 12px !important;
            }

            .locate-btn {
                bottom: 100px;
                right: 20px;
            }

            .live-orbit-btn {
                bottom: 170px;
                right: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Zone A: Command Rail -->
    <nav class="command-rail">
        <div class="rail-top">
            <!-- Login Button (Vibrant Glow) -->
            <div id="loginBtn" class="nav-item" title="Login" onclick="window.location.href='login.html'"
                style="width: 56px; height: 56px; font-size: 26px; border: 2px solid var(--accent-glow); color: var(--accent-glow); box-shadow: 0 0 15px rgba(144, 238, 144, 0.2); background: rgba(144, 238, 144, 0.05); border-radius: 18px;">
                <i class='bx bx-log-in'></i>
            </div>
            <!-- Logout Button (Vibrant Red Glow) -->
            <div id="logoutBtn" class="nav-item" title="Logout" onclick="window.logout()"
                style="display: none; width: 56px; height: 56px; font-size: 26px; border: 2px solid #EF4444; color: #EF4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05); border-radius: 18px;">
                <i class='bx bx-log-out'></i>
            </div>
        </div>

        <div class="nav-icons">
            <div id="nav-map" class="nav-item active" title="World Orbit" onclick="showPanel('map')">
                <i class='bx bx-globe'></i>
            </div>
            <div id="nav-loc" class="nav-item" title="Sync Location" onclick="showPanel('loc'); getMyLocation()">
                <i class='bx bx-map-pin'></i>
            </div>
            <div id="nav-stats" class="nav-item" title="Garden Bio-Stats"
                onclick="window.location.href='locations.html'">
                <i class='bx bx-bar-chart-alt-2'></i>
            </div>
            <div id="nav-settings" class="nav-item" title="System Settings" onclick="openPlantTray()">
                <i class='bx bx-cog'></i>
            </div>
            <!-- Moved Theme Switch -->
            <div class="theme-switch" id="themeToggle" onclick="window.toggleTheme()" title="Toggle Theme">
                <i class='bx bx-moon'></i>
            </div>
        </div>
    </nav>

    <!-- Zone B: Primary Viewport -->
    <main class="viewport-center">
        <div class="branding-overlay"
            style="position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 20; pointer-events: none;">
            <h1
                style="font-size: 10px; font-weight: 800; letter-spacing: 4px; color: var(--accent-glow); margin: 0; opacity: 0.6; text-transform: uppercase;">
                DIGITAL PLANTER</h1>
        </div>
        <div class="floating-search">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                style="color: var(--accent-glow)">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="searchLocation" placeholder="Locate environmental coordinates..."
                onkeypress="if(event.key==='Enter') searchLocation()">
        </div>

        <div id="map"></div>

        <button id="locateMeBtn" class="locate-btn" onclick="getMyLocation()" title="Sync Current Coordinates">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06a8.994 8.994 0 007.94 7.94V23h2v-2.06a8.994 8.994 0 007.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z">
                </path>
            </svg>
        </button>

        <button id="liveOrbitBtn" class="live-orbit-btn" onclick="window.toggleLiveTracking()"
            title="Live Orbit Tracking">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
            </svg>
        </button>

        <div id="liveStatusBar" class="live-status-bar">
            <div class="live-status-label">Live Coordinates</div>
            <div id="liveCoords" class="live-status-value">Searching...</div>
            <div id="liveAddress" class="live-status-value" style="font-size: 9px; opacity: 0.7;">Unknown Sector</div>
        </div>

        <div id="status-overlay"></div>
    </main>

    <!-- Permission Backdrop & Modal -->
    <div id="modalOverlay" class="modal-overlay" onclick="closePermissionModal()"></div>
    <div id="permissionModal" class="permission-modal">
        <h2 style="font-size: 24px; color: var(--accent-glow);">SIGNAL BLOCKED</h2>
        <p style="font-size: 14px; line-height: 1.6; opacity: 0.8;">
            Your browser's security barrier is preventing environmental synchronization.<br><br>
            Please click the <strong>Tune/Lock icon</strong> next to the URL above, and set <strong>Location</strong> to
            <strong>"Allow"</strong> or <strong>"Ask"</strong>.
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
            <button class="btn-deploy"
                onclick="closePermissionModal(); document.getElementById('searchLocation').focus()">MANUAL SEARCH
                FALLBACK</button>
            <button class="btn-secondary" onclick="closePermissionModal()">UNDERSTOOD</button>
        </div>
    </div>

    <!-- Zone C: Action Tray -->
    <aside class="action-tray" id="actionTray">
        <div class="tray-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 28px; font-weight: 800; letter-spacing: -1px;">Plant New Life</h2>
                <span style="cursor: pointer; font-size: 24px; color: var(--text-muted);"
                    onclick="closePlantTray()">&times;</span>
            </div>
            <p
                style="color: var(--accent-glow); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px;">
                Initialize biological insertion
            </p>
        </div>

        <div class="tray-content" style="display: flex; flex-direction: column; gap: 32px;">
            <!-- Photo Capture -->
            <div class="photo-drop-zone" onclick="document.getElementById('photoInput').click()">
                <div id="uploadPlaceholder" style="text-align: center;">
                    <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="color: var(--accent-glow); margin-bottom: 12px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <p style="font-size: 11px; font-weight: 700; letter-spacing: 1.5px; opacity: 0.7;">CAPTURE
                        BIOMETRIC DATA</p>
                </div>
                <img id="photoPreview" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="previewPhoto(event)">
            </div>

            <!-- Identity -->
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <label class="tray-section-title">Species Identity</label>
                <input type="text" id="plantName" class="premium-input" placeholder="e.g. Neon Moss or Sky Fern">
            </div>

            <!-- Classification -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="nav-item"
                    style="width: 100%; height: 70px; border: 1px solid var(--border-glass); flex-direction: column; font-size: 14px;"
                    onclick="selectType('tree')" id="card-tree">
                    <span style="font-size: 24px;">ðŸŒ³</span>
                    <span
                        style="font-size: 9px; font-weight: 800; letter-spacing: 1px; margin-top: 4px;">ARBOREAL</span>
                </div>
                <div class="nav-item"
                    style="width: 100%; height: 70px; border: 1px solid var(--border-glass); flex-direction: column; font-size: 14px;"
                    onclick="selectType('flower')" id="card-flower">
                    <span style="font-size: 24px;">ðŸŒ¸</span>
                    <span style="font-size: 9px; font-weight: 800; letter-spacing: 1px; margin-top: 4px;">FLORAL</span>
                </div>
            </div>
            <input type="hidden" id="plantType" value="tree">

            <!-- Location Meta -->
            <div class="detail-section">
                <label class="tray-section-title">Sync Coordinates</label>
                <div id="locationMeta"
                    style="font-size: 13px; color: var(--text-muted); padding: 16px; background: rgba(255,255,255,0.03); border-radius: var(--radius-md); border-left: 2px solid var(--accent-glow); line-height: 1.6;">
                    Select map origin to initialize link...
                </div>
            </div>

            <!-- Recent Encounters -->
            <div class="detail-section">
                <label class="tray-section-title">Recent Encounters</label>
                <div id="recentHistory" class="history-list">
                    <div class="history-item" style="opacity: 0.5;">No recent data streams...</div>
                </div>
            </div>

            <!-- Social Transmission -->
            <div class="detail-section">
                <label class="tray-section-title">Transmit to Gardeners</label>
                <div class="social-share-grid">
                    <div class="social-btn" title="WhatsApp Transmit" onclick="shareSocial('wa')">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766 0-3.18-2.587-5.765-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.17.824-.299.045-.677.063-1.092-.069-.252-.08-.575-.187-.988-.365-1.739-.747-2.874-2.512-2.96-2.626-.088-.113-.716-.953-.716-1.819 0-.866.454-1.292.614-1.457.16-.165.346-.207.461-.207s.231.001.332.005c.109.004.256-.041.4.31.144.35.493 1.205.536 1.292.042.087.071.188.012.302-.058.113-.087.188-.173.289l-.26.302c-.088.102-.18.212-.077.389.103.177.456.751.979 1.216.674.599 1.242.785 1.419.873.177.088.281.074.385-.046.103-.121.442-.513.561-.689.118-.176.237-.148.4-.087.163.061 1.03.486 1.208.574s.296.132.34.207c.044.076.044.439-.1.844z" />
                        </svg>
                    </div>
                    <div class="social-btn" title="Twitter / X Transmit" onclick="shareSocial('tw')">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.25 2.25h6.663l4.715 6.235zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                        </svg>
                    </div>
                    <div class="social-btn" title="LinkedIn Transmit" onclick="shareSocial('li')">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                        </svg>
                    </div>
                    <div class="social-btn" title="System Clipboard" onclick="shareSocial('clip')">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <button class="btn-deploy" id="deployBtn" onclick="submitPlant()">DEPLOY BIOMASS</button>
        </div>
    </aside>

    <!-- Login Modal Removed (Using /login page instead) -->

    <script type="module">
        import { auth } from "./static/js/config.js";
        import { addPlant, getUserPlants, deletePlant } from "./static/js/dataService.js";
        import { reverseGeocode } from "./static/js/utils.js";
        import { toggleTheme } from "./static/js/theme.js";

        // Global Bridges
        window.toggleTheme = toggleTheme;
        window.plantWithLocalStorage = async function (name, type, lat, lon, photoDataUrl) {
            try {
                const geoData = await reverseGeocode(lat, lon);
                const newPlant = await addPlant({
                    name, type, lat, lon, photo_url: photoDataUrl,
                    address: geoData.address, landmarks: geoData.landmarks
                });
                return { success: true, plant: newPlant };
            } catch (error) {
                console.error("Planting error:", error);
                return { success: false, error: error.message };
            }
        };

        window.handleDeleteFromHistory = async function (id) {
            if (confirm("TERMINATE THIS RECORD?")) {
                if (await deletePlant(id)) {
                    await loadHistory();
                }
            }
        };

        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

        window.logout = async () => {
            if (confirm("TERMINATE SESSION?")) {
                try {
                    await auth.signOut();
                    window.location.reload();
                } catch (e) {
                    console.error("Logout Error:", e);
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (user) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'flex';
            } else {
                if (loginBtn) loginBtn.style.display = 'flex';
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
            loadHistory();
        });

        async function loadHistory() {
            const container = document.getElementById('recentHistory');
            try {
                const plants = (await getUserPlants()).slice(-3).reverse();
                if (plants.length > 0) {
                    container.innerHTML = plants.map(p => `
                        <div class="history-item">
                            <span>${p.type === 'tree' ? 'ðŸŒ³' : 'ðŸŒ¸'}</span>
                            <div style="flex:1">
                                <div style="font-weight:700">${p.name.replace(/[ðŸŒ³ðŸŒ¸]/g, '').toUpperCase()}</div>
                                <div style="font-size:10px; opacity:0.6">${p.address ? p.address.split(',')[0] : 'Remote sector'}</div>
                            </div>
                            <button class="delete-btn-history" onclick="window.handleDeleteFromHistory('${p.id}')">
                                &times;
                            </button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="history-item" style="opacity: 0.5;">No recent data streams...</div>';
                }
            } catch (e) {
                console.error("Error loading history:", e);
                container.innerHTML = '<div class="history-item" style="opacity: 0.5;">Error loading history.</div>';
            }
        }
        window.loadHistory = loadHistory;
    </script>

    <script>
        let map, selectedMarker, selectedLat, selectedLon;
        const statusEl = document.getElementById('status-overlay');

        function showPanel(panel) {
            // Update active state in rail
            document.querySelectorAll('.nav-icons .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`nav-${panel === 'map' ? 'map' : (panel === 'loc' ? 'loc' : (panel === 'stats' ? 'stats' : 'settings'))}`).classList.add('active');

            if (panel === 'settings') {
                openPlantTray();
            } else {
                closePlantTray();
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            map.on('click', function (e) {
                selectedLat = e.latlng.lat;
                selectedLon = e.latlng.lng;

                if (selectedMarker) map.removeLayer(selectedMarker);

                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: var(--accent-glow); width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 15px var(--accent-glow);"></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });

                selectedMarker = L.marker([selectedLat, selectedLon], { icon: customIcon }).addTo(map);

                updateLocationMeta(selectedLat, selectedLon);
                openPlantTray();
                showStatus('COORDINATES PINNED', 'success');
            });
        }

        function updateLocationMeta(lat, lon) {
            const meta = document.getElementById('locationMeta');
            meta.innerHTML = `SECTOR: ${lat.toFixed(4)}N, ${lon.toFixed(4)}E<br><span style="color: var(--accent-glow); font-size: 10px; font-weight:800">DECRYPTING ADDRESS...</span>`;

            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(res => res.json())
                .then(data => {
                    const addr = data.address;
                    meta.innerHTML = `<strong>${addr.road || addr.suburb || 'Central Sector'}</strong><br>${addr.city || addr.town || addr.state}, ${addr.country}<br><span style="font-size:10px; opacity:0.5">${lat.toFixed(5)}, ${lon.toFixed(5)}</span>`;
                }).catch(() => meta.innerHTML = `STREAM OFFLINE<br>${lat.toFixed(4)}, ${lon.toFixed(4)}`);
        }

        function openPlantTray() {
            document.getElementById('actionTray').classList.add('open');
        }

        function closePlantTray() {
            document.getElementById('actionTray').classList.remove('open');
        }

        async function searchLocation() {
            const query = document.getElementById('searchLocation').value.trim();
            if (!query) return;
            showStatus('SCANNING...', 'info');
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                const results = await res.json();
                if (results.length > 0) {
                    const { lat, lon } = results[0];
                    map.setView([parseFloat(lat), parseFloat(lon)], 15);
                    showStatus('ORBIT SYNCED', 'success');
                }
            } catch (e) { showStatus('SCAN FAILURE', 'error'); }
        }

        function openPermissionModal() {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('permissionModal').classList.add('active');
        }

        function closePermissionModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('permissionModal').classList.remove('active');
        }

        function getMyLocation() {
            if (!navigator.geolocation) return;
            showStatus('RECEPTUALIZING...', 'info');
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 15);
                showStatus('SIGNAL STABLE', 'success');

                // Set coordinates
                selectedLat = latitude;
                selectedLon = longitude;

                // Drop visual pin
                if (selectedMarker) map.removeLayer(selectedMarker);
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: var(--accent-glow); width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 20px var(--accent-glow);"></div>`,
                    iconSize: [14, 14], iconAnchor: [7, 7]
                });
                selectedMarker = L.marker([latitude, longitude], { icon: customIcon }).addTo(map);

                // Initialize tray
                updateLocationMeta(latitude, longitude);
                openPlantTray();
            }, (err) => {
                if (err.code === err.PERMISSION_DENIED) {
                    showStatus('SIGNAL BLOCKED', 'error');
                    openPermissionModal();
                } else {
                    showStatus('JAMMED SIGNAL', 'error');
                }
            });
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const rd = new FileReader();
                rd.onload = (e) => {
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    const prev = document.getElementById('photoPreview');
                    prev.src = e.target.result; prev.style.display = 'block';
                };
                rd.readAsDataURL(file);
            }
        }

        function selectType(type) {
            document.getElementById('plantType').value = type;
            document.querySelectorAll('.tray-content .nav-item').forEach(i => i.style.borderColor = 'var(--border-glass)');
            document.getElementById(`card-${type}`).style.borderColor = 'var(--accent-glow)';
        }

        async function submitPlant() {
            const name = document.getElementById('plantName').value.trim();
            const type = document.getElementById('plantType').value;
            const btn = document.getElementById('deployBtn');
            const photoInput = document.getElementById('photoInput');

            if (!name || !selectedLat) {
                showStatus('DATA INCOMPLETE', 'error');
                return;
            }

            btn.disabled = true; btn.textContent = 'DEPLOYING...';
            showStatus('COMMENCING INSERTION...', 'info');

            try {
                let photoDataUrl = null;
                if (photoInput.files[0]) {
                    photoDataUrl = await new Promise(r => {
                        const rd = new FileReader();
                        rd.onload = (e) => r(e.target.result);
                        rd.readAsDataURL(photoInput.files[0]);
                    });
                }

                const result = await window.plantWithLocalStorage(name, type, selectedLat, selectedLon, photoDataUrl);
                if (result.success) {
                    showStatus('MISSION SUCCESSFUL', 'success');
                    setTimeout(() => {
                        closePlantTray();
                        window.loadHistory();
                        // Reset
                        document.getElementById('plantName').value = '';
                        document.getElementById('photoPreview').style.display = 'none';
                        document.getElementById('uploadPlaceholder').style.display = 'flex';
                        if (selectedMarker) map.removeLayer(selectedMarker);
                        btn.disabled = false; btn.textContent = 'DEPLOY BIOMASS';
                    }, 1000);
                }
            } catch (e) { showStatus('CRITICAL FAILURE', 'error'); btn.disabled = false; btn.textContent = 'RETRY DEPLOYMENT'; }
        }

        function showStatus(msg, type) {
            statusEl.textContent = msg;
            statusEl.style.color = type === 'error' ? '#F87171' : (type === 'success' ? 'var(--accent-glow)' : '#60A5FA');
            statusEl.style.opacity = '1';
            setTimeout(() => statusEl.style.opacity = '0', 3000);
        }

        let watchId = null;

        window.toggleLiveTracking = function () {
            const btn = document.getElementById('liveOrbitBtn');
            const statusBar = document.getElementById('liveStatusBar');

            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                btn.classList.remove('active');
                statusBar.classList.remove('active');
                showStatus('LIVE ORBIT DISABLED', 'info');
            } else {
                if (!navigator.geolocation) return;
                showStatus('INITIALIZING LIVE ORBIT...', 'info');
                btn.classList.add('active');
                statusBar.classList.add('active');

                watchId = navigator.geolocation.watchPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    updateLiveLocation(latitude, longitude);
                }, (err) => {
                    showStatus('SIGNAL FAILURE', 'error');
                    window.toggleLiveTracking();
                }, { enableHighAccuracy: true });
            }
        };

        function updateLiveLocation(lat, lon) {
            document.getElementById('liveCoords').textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;

            // Move map and marker
            map.setView([lat, lon], 17);
            if (selectedMarker) map.removeLayer(selectedMarker);

            const liveIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: var(--accent-glow); width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 20px var(--accent-glow); border: 2px solid white;"></div>`,
                iconSize: [14, 14], iconAnchor: [7, 7]
            });
            selectedMarker = L.marker([lat, lon], { icon: liveIcon }).addTo(map);

            // Update status bar address
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('liveAddress').textContent = data.display_name.split(',')[0] || 'Direct Signal';
                });
        }

        function shareSocial(type) {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent("I just planted a new life in the Digital Forest! ðŸŒ± Join the ecosystem.");
            let shareUrl = '';
            if (type === 'wa') shareUrl = `https://wa.me/?text=${text}%20${url}`;
            else if (type === 'tw') shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
            else if (type === 'li') shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
            else if (type === 'clip') {
                navigator.clipboard.writeText(`I just planted a new life! ${window.location.href}`);
                showStatus('PACKET COPIED', 'success');
                return;
            }
            if (shareUrl) window.open(shareUrl, '_blank');
        }

        initMap();
    </script>
    <script type="module" src="static/js/main.js"></script>
    <script>
        // Boxicons initialized automatically
    </script>
</body>

</html>